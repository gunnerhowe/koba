openapi: 3.1.0
info:
  title: VACP - Verified AI Communication Protocol
  description: |
    Production-ready API for secure, auditable AI agent communication.

    ## Overview

    VACP provides a comprehensive protocol for managing AI agent communications with:
    - **Cryptographic signing** of all messages
    - **Blockchain anchoring** for immutable audit trails
    - **Token management** with fine-grained permissions
    - **Prompt injection detection** for security
    - **HIPAA-compliant audit logging**

    ## Authentication

    All API endpoints (except health checks) require authentication via API key.
    Include the API key in the `X-API-Key` header:

    ```
    X-API-Key: your-api-key-here
    ```

    ## Rate Limiting

    API requests are rate limited per tenant. Default limits:
    - 100 requests per minute per tenant
    - Burst limit of 10 concurrent requests

    Rate limit headers are included in responses:
    - `X-RateLimit-Limit`: Maximum requests per window
    - `X-RateLimit-Remaining`: Remaining requests in current window
    - `X-RateLimit-Reset`: Unix timestamp when window resets

    ## Error Handling

    All errors follow RFC 7807 Problem Details format:

    ```json
    {
      "type": "https://vacp.example.com/errors/validation",
      "title": "Validation Error",
      "status": 400,
      "detail": "Request body failed validation",
      "instance": "/api/v1/messages",
      "errors": [...]
    }
    ```

  version: 1.0.0
  contact:
    name: VACP Security Team
    email: security@example.com
    url: https://github.com/example/vacp
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0

servers:
  - url: https://api.vacp.example.com/api/v1
    description: Production server
  - url: https://staging-api.vacp.example.com/api/v1
    description: Staging server
  - url: http://localhost:8000/api/v1
    description: Local development server

tags:
  - name: Health
    description: Service health and readiness endpoints
  - name: Tokens
    description: Token management for AI agents
  - name: Messages
    description: Signed message operations
  - name: Audit
    description: Audit log access and management
  - name: Blockchain
    description: Blockchain anchoring operations
  - name: Security
    description: Security and threat detection
  - name: Admin
    description: Administrative operations

paths:
  # ==========================================================================
  # Health Endpoints
  # ==========================================================================
  /health/live:
    get:
      tags:
        - Health
      summary: Liveness probe
      description: |
        Returns 200 if the service is alive. Used by Kubernetes liveness probes.
        This endpoint does not check dependencies.
      operationId: getLiveness
      security: []
      responses:
        "200":
          description: Service is alive
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"
              example:
                status: ok
                timestamp: "2024-01-15T10:30:00Z"

  /health/ready:
    get:
      tags:
        - Health
      summary: Readiness probe
      description: |
        Returns 200 if the service is ready to accept traffic.
        Checks database connectivity, cache, and other dependencies.
      operationId: getReadiness
      security: []
      responses:
        "200":
          description: Service is ready
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReadinessResponse"
        "503":
          description: Service is not ready
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReadinessResponse"

  /health/startup:
    get:
      tags:
        - Health
      summary: Startup probe
      description: |
        Returns 200 once initial startup is complete.
        Used by Kubernetes startup probes.
      operationId: getStartup
      security: []
      responses:
        "200":
          description: Startup complete
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"
        "503":
          description: Still starting up
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"

  # ==========================================================================
  # Token Endpoints
  # ==========================================================================
  /tokens:
    get:
      tags:
        - Tokens
      summary: List tokens
      description: |
        List all tokens for the authenticated tenant.
        Supports pagination and filtering.
      operationId: listTokens
      parameters:
        - $ref: "#/components/parameters/PageParam"
        - $ref: "#/components/parameters/PageSizeParam"
        - name: status
          in: query
          description: Filter by token status
          schema:
            type: string
            enum: [active, revoked, expired]
        - name: agent_id
          in: query
          description: Filter by agent ID
          schema:
            type: string
      responses:
        "200":
          description: List of tokens
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TokenListResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "429":
          $ref: "#/components/responses/RateLimited"

    post:
      tags:
        - Tokens
      summary: Create a new token
      description: |
        Create a new token for an AI agent.
        The token grants specific permissions and has an optional expiration.
      operationId: createToken
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateTokenRequest"
      responses:
        "201":
          description: Token created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TokenResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "429":
          $ref: "#/components/responses/RateLimited"

  /tokens/{token_id}:
    get:
      tags:
        - Tokens
      summary: Get token details
      description: Get detailed information about a specific token.
      operationId: getToken
      parameters:
        - $ref: "#/components/parameters/TokenIdParam"
      responses:
        "200":
          description: Token details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TokenResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

    delete:
      tags:
        - Tokens
      summary: Revoke a token
      description: |
        Revoke a token immediately. The token will no longer be valid
        for any operations. This action cannot be undone.
      operationId: revokeToken
      parameters:
        - $ref: "#/components/parameters/TokenIdParam"
      responses:
        "204":
          description: Token revoked successfully
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  /tokens/{token_id}/rotate:
    post:
      tags:
        - Tokens
      summary: Rotate a token
      description: |
        Rotate a token by generating a new secret while keeping the same token ID.
        The old secret is invalidated immediately.
      operationId: rotateToken
      parameters:
        - $ref: "#/components/parameters/TokenIdParam"
      responses:
        "200":
          description: Token rotated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TokenResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  # ==========================================================================
  # Message Endpoints
  # ==========================================================================
  /messages:
    post:
      tags:
        - Messages
      summary: Create and sign a message
      description: |
        Create a new signed message from an AI agent.
        The message is cryptographically signed and logged to the audit trail.
      operationId: createMessage
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateMessageRequest"
      responses:
        "201":
          description: Message created and signed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: Message rejected (prompt injection detected or policy violation)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SecurityRejectionResponse"
        "429":
          $ref: "#/components/responses/RateLimited"

  /messages/{message_id}:
    get:
      tags:
        - Messages
      summary: Get message details
      description: Get detailed information about a specific message including signature.
      operationId: getMessage
      parameters:
        - name: message_id
          in: path
          required: true
          description: Message ID
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Message details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  /messages/{message_id}/verify:
    post:
      tags:
        - Messages
      summary: Verify message signature
      description: |
        Verify that a message signature is valid and has not been tampered with.
        Also verifies blockchain anchoring if available.
      operationId: verifyMessage
      parameters:
        - name: message_id
          in: path
          required: true
          description: Message ID
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Verification result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VerificationResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  # ==========================================================================
  # Audit Endpoints
  # ==========================================================================
  /audit/logs:
    get:
      tags:
        - Audit
      summary: Query audit logs
      description: |
        Query the audit log with various filters.
        Returns a paginated list of audit entries.
      operationId: queryAuditLogs
      parameters:
        - $ref: "#/components/parameters/PageParam"
        - $ref: "#/components/parameters/PageSizeParam"
        - name: start_time
          in: query
          description: Start of time range (ISO 8601)
          schema:
            type: string
            format: date-time
        - name: end_time
          in: query
          description: End of time range (ISO 8601)
          schema:
            type: string
            format: date-time
        - name: action
          in: query
          description: Filter by action type
          schema:
            type: string
            enum: [message_created, token_issued, token_revoked, verification_performed]
        - name: agent_id
          in: query
          description: Filter by agent ID
          schema:
            type: string
        - name: correlation_id
          in: query
          description: Filter by correlation ID
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Audit log entries
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuditLogResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "429":
          $ref: "#/components/responses/RateLimited"

  /audit/logs/{entry_id}:
    get:
      tags:
        - Audit
      summary: Get audit log entry
      description: Get detailed information about a specific audit log entry.
      operationId: getAuditEntry
      parameters:
        - name: entry_id
          in: path
          required: true
          description: Audit entry ID
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Audit entry details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuditEntry"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  /audit/export:
    post:
      tags:
        - Audit
      summary: Export audit logs
      description: |
        Export audit logs for a specified time range.
        Supports multiple formats: JSON, CSV, SIEM.
      operationId: exportAuditLogs
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AuditExportRequest"
      responses:
        "202":
          description: Export job started
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExportJobResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  # ==========================================================================
  # Blockchain Endpoints
  # ==========================================================================
  /blockchain/anchors:
    get:
      tags:
        - Blockchain
      summary: List blockchain anchors
      description: List all blockchain anchoring operations.
      operationId: listAnchors
      parameters:
        - $ref: "#/components/parameters/PageParam"
        - $ref: "#/components/parameters/PageSizeParam"
        - name: status
          in: query
          description: Filter by anchor status
          schema:
            type: string
            enum: [pending, confirmed, failed]
      responses:
        "200":
          description: List of anchors
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AnchorListResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /blockchain/anchors/{anchor_id}:
    get:
      tags:
        - Blockchain
      summary: Get anchor details
      description: |
        Get detailed information about a blockchain anchor,
        including transaction hash and confirmation status.
      operationId: getAnchor
      parameters:
        - name: anchor_id
          in: path
          required: true
          description: Anchor ID
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Anchor details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AnchorResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  /blockchain/verify:
    post:
      tags:
        - Blockchain
      summary: Verify blockchain proof
      description: |
        Verify that data exists on the blockchain and has not been modified.
        Provides cryptographic proof of inclusion.
      operationId: verifyBlockchainProof
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/BlockchainVerifyRequest"
      responses:
        "200":
          description: Verification result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BlockchainVerifyResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  # ==========================================================================
  # Security Endpoints
  # ==========================================================================
  /security/scan:
    post:
      tags:
        - Security
      summary: Scan content for threats
      description: |
        Scan content for prompt injection, PII, and other security threats.
        Returns detailed threat analysis.
      operationId: scanContent
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SecurityScanRequest"
      responses:
        "200":
          description: Scan results
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SecurityScanResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /security/kill-switch:
    post:
      tags:
        - Security
        - Admin
      summary: Activate kill switch
      description: |
        Activate the emergency kill switch to disable all agent operations.
        This is a critical security operation that requires additional authorization.
      operationId: activateKillSwitch
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/KillSwitchRequest"
      responses:
        "200":
          description: Kill switch activated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/KillSwitchResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: Insufficient permissions
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  # ==========================================================================
  # Admin Endpoints
  # ==========================================================================
  /admin/tenants:
    get:
      tags:
        - Admin
      summary: List tenants
      description: List all tenants (super admin only).
      operationId: listTenants
      parameters:
        - $ref: "#/components/parameters/PageParam"
        - $ref: "#/components/parameters/PageSizeParam"
      responses:
        "200":
          description: List of tenants
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TenantListResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: Requires super admin
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    post:
      tags:
        - Admin
      summary: Create tenant
      description: Create a new tenant (super admin only).
      operationId: createTenant
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateTenantRequest"
      responses:
        "201":
          description: Tenant created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TenantResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: Requires super admin
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /admin/metrics:
    get:
      tags:
        - Admin
      summary: Get system metrics
      description: Get system metrics in Prometheus format.
      operationId: getMetrics
      responses:
        "200":
          description: Metrics in Prometheus format
          content:
            text/plain:
              schema:
                type: string

components:
  # ==========================================================================
  # Security Schemes
  # ==========================================================================
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key for authentication

    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token for authentication

  # ==========================================================================
  # Parameters
  # ==========================================================================
  parameters:
    PageParam:
      name: page
      in: query
      description: Page number (1-indexed)
      schema:
        type: integer
        minimum: 1
        default: 1

    PageSizeParam:
      name: page_size
      in: query
      description: Number of items per page
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20

    TokenIdParam:
      name: token_id
      in: path
      required: true
      description: Token ID
      schema:
        type: string
        format: uuid

  # ==========================================================================
  # Responses
  # ==========================================================================
  responses:
    BadRequest:
      description: Invalid request
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"

    Unauthorized:
      description: Authentication required
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"

    RateLimited:
      description: Rate limit exceeded
      headers:
        X-RateLimit-Limit:
          schema:
            type: integer
          description: Request limit per window
        X-RateLimit-Remaining:
          schema:
            type: integer
          description: Remaining requests in window
        X-RateLimit-Reset:
          schema:
            type: integer
          description: Unix timestamp when window resets
        Retry-After:
          schema:
            type: integer
          description: Seconds until retry allowed
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"

  # ==========================================================================
  # Schemas
  # ==========================================================================
  schemas:
    # Health Schemas
    HealthResponse:
      type: object
      required:
        - status
        - timestamp
      properties:
        status:
          type: string
          enum: [ok, degraded, unhealthy]
        timestamp:
          type: string
          format: date-time
        version:
          type: string
          example: "1.0.0"

    ReadinessResponse:
      type: object
      required:
        - status
        - checks
      properties:
        status:
          type: string
          enum: [ok, degraded, unhealthy]
        checks:
          type: object
          additionalProperties:
            $ref: "#/components/schemas/HealthCheck"
        timestamp:
          type: string
          format: date-time

    HealthCheck:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          enum: [ok, degraded, unhealthy]
        latency_ms:
          type: number
          format: float
        message:
          type: string

    # Token Schemas
    CreateTokenRequest:
      type: object
      required:
        - agent_id
        - permissions
      properties:
        agent_id:
          type: string
          description: Unique identifier for the AI agent
          example: "agent-openai-gpt4"
        name:
          type: string
          description: Human-readable name for the token
          example: "Production GPT-4 Agent"
        permissions:
          type: array
          items:
            type: string
            enum: [message:create, message:read, audit:read, token:rotate]
          description: List of permissions granted to this token
        expires_at:
          type: string
          format: date-time
          description: Token expiration time (optional)
        metadata:
          type: object
          additionalProperties:
            type: string
          description: Custom metadata

    TokenResponse:
      type: object
      required:
        - id
        - agent_id
        - status
        - created_at
      properties:
        id:
          type: string
          format: uuid
        agent_id:
          type: string
        name:
          type: string
        secret:
          type: string
          description: Token secret (only returned on create/rotate)
        permissions:
          type: array
          items:
            type: string
        status:
          type: string
          enum: [active, revoked, expired]
        created_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time
        last_used_at:
          type: string
          format: date-time
        metadata:
          type: object
          additionalProperties:
            type: string

    TokenListResponse:
      type: object
      required:
        - items
        - total
        - page
        - page_size
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/TokenResponse"
        total:
          type: integer
        page:
          type: integer
        page_size:
          type: integer

    # Message Schemas
    CreateMessageRequest:
      type: object
      required:
        - content
      properties:
        content:
          type: string
          description: Message content
          maxLength: 100000
        content_type:
          type: string
          enum: [text, json, markdown]
          default: text
        correlation_id:
          type: string
          format: uuid
          description: ID to correlate related messages
        parent_message_id:
          type: string
          format: uuid
          description: Parent message ID for threaded conversations
        metadata:
          type: object
          additionalProperties: true
          description: Custom metadata

    MessageResponse:
      type: object
      required:
        - id
        - content
        - signature
        - created_at
      properties:
        id:
          type: string
          format: uuid
        content:
          type: string
        content_type:
          type: string
        content_hash:
          type: string
          description: SHA-256 hash of content
        signature:
          type: string
          description: Ed25519 signature (base64)
        public_key:
          type: string
          description: Public key used for signing (base64)
        agent_id:
          type: string
        correlation_id:
          type: string
          format: uuid
        parent_message_id:
          type: string
          format: uuid
        created_at:
          type: string
          format: date-time
        blockchain_anchor:
          $ref: "#/components/schemas/AnchorSummary"
        metadata:
          type: object
          additionalProperties: true

    VerificationResponse:
      type: object
      required:
        - valid
        - verified_at
      properties:
        valid:
          type: boolean
        signature_valid:
          type: boolean
        content_hash_valid:
          type: boolean
        blockchain_verified:
          type: boolean
        blockchain_proof:
          $ref: "#/components/schemas/BlockchainProof"
        verified_at:
          type: string
          format: date-time
        details:
          type: object
          additionalProperties: true

    # Audit Schemas
    AuditEntry:
      type: object
      required:
        - id
        - action
        - timestamp
      properties:
        id:
          type: string
          format: uuid
        action:
          type: string
          enum: [message_created, token_issued, token_revoked, verification_performed, security_alert]
        actor_id:
          type: string
        actor_type:
          type: string
          enum: [agent, user, system]
        resource_type:
          type: string
        resource_id:
          type: string
        correlation_id:
          type: string
          format: uuid
        timestamp:
          type: string
          format: date-time
        ip_address:
          type: string
        user_agent:
          type: string
        request_id:
          type: string
        details:
          type: object
          additionalProperties: true

    AuditLogResponse:
      type: object
      required:
        - items
        - total
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/AuditEntry"
        total:
          type: integer
        page:
          type: integer
        page_size:
          type: integer
        has_more:
          type: boolean

    AuditExportRequest:
      type: object
      required:
        - start_time
        - end_time
        - format
      properties:
        start_time:
          type: string
          format: date-time
        end_time:
          type: string
          format: date-time
        format:
          type: string
          enum: [json, csv, siem]
        filters:
          type: object
          properties:
            actions:
              type: array
              items:
                type: string
            agent_ids:
              type: array
              items:
                type: string

    ExportJobResponse:
      type: object
      required:
        - job_id
        - status
      properties:
        job_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [pending, processing, completed, failed]
        download_url:
          type: string
          format: uri
        expires_at:
          type: string
          format: date-time

    # Blockchain Schemas
    AnchorSummary:
      type: object
      properties:
        anchor_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [pending, confirmed, failed]
        network:
          type: string
          enum: [hedera, ethereum]
        transaction_id:
          type: string

    AnchorResponse:
      type: object
      required:
        - id
        - merkle_root
        - status
      properties:
        id:
          type: string
          format: uuid
        merkle_root:
          type: string
        tree_size:
          type: integer
        status:
          type: string
          enum: [pending, confirmed, failed]
        network:
          type: string
          enum: [hedera, ethereum]
        transaction_id:
          type: string
        transaction_url:
          type: string
          format: uri
        consensus_timestamp:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time
        confirmed_at:
          type: string
          format: date-time

    AnchorListResponse:
      type: object
      required:
        - items
        - total
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/AnchorResponse"
        total:
          type: integer
        page:
          type: integer
        page_size:
          type: integer

    BlockchainVerifyRequest:
      type: object
      required:
        - data_hash
      properties:
        data_hash:
          type: string
          description: SHA-256 hash of the data to verify
        anchor_id:
          type: string
          format: uuid
          description: Specific anchor to verify against

    BlockchainVerifyResponse:
      type: object
      required:
        - verified
      properties:
        verified:
          type: boolean
        anchor_id:
          type: string
          format: uuid
        proof:
          $ref: "#/components/schemas/BlockchainProof"
        verified_at:
          type: string
          format: date-time

    BlockchainProof:
      type: object
      properties:
        merkle_path:
          type: array
          items:
            type: object
            properties:
              hash:
                type: string
              position:
                type: string
                enum: [left, right]
        root_hash:
          type: string
        leaf_index:
          type: integer
        tree_size:
          type: integer
        transaction_id:
          type: string
        network:
          type: string

    # Security Schemas
    SecurityScanRequest:
      type: object
      required:
        - content
      properties:
        content:
          type: string
          description: Content to scan
        scan_types:
          type: array
          items:
            type: string
            enum: [prompt_injection, pii, malware, policy_violation]
          default: [prompt_injection, pii]

    SecurityScanResponse:
      type: object
      required:
        - safe
        - threats
      properties:
        safe:
          type: boolean
        risk_score:
          type: number
          format: float
          minimum: 0
          maximum: 1
        threats:
          type: array
          items:
            $ref: "#/components/schemas/ThreatDetail"
        scanned_at:
          type: string
          format: date-time

    ThreatDetail:
      type: object
      required:
        - type
        - severity
      properties:
        type:
          type: string
          enum: [prompt_injection, pii, malware, policy_violation]
        severity:
          type: string
          enum: [low, medium, high, critical]
        confidence:
          type: number
          format: float
        description:
          type: string
        location:
          type: object
          properties:
            start:
              type: integer
            end:
              type: integer

    SecurityRejectionResponse:
      type: object
      required:
        - rejected
        - reason
      properties:
        rejected:
          type: boolean
          default: true
        reason:
          type: string
        threat_type:
          type: string
        details:
          type: string

    KillSwitchRequest:
      type: object
      required:
        - reason
        - scope
      properties:
        reason:
          type: string
          description: Reason for activating kill switch
        scope:
          type: string
          enum: [all, tenant, agent]
        target_id:
          type: string
          description: Target tenant or agent ID (required if scope is not 'all')
        duration_minutes:
          type: integer
          description: Duration in minutes (0 for permanent)
          default: 0

    KillSwitchResponse:
      type: object
      required:
        - activated
        - scope
      properties:
        activated:
          type: boolean
        scope:
          type: string
        target_id:
          type: string
        activated_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time
        activation_id:
          type: string
          format: uuid

    # Admin Schemas
    CreateTenantRequest:
      type: object
      required:
        - name
        - admin_email
      properties:
        name:
          type: string
        admin_email:
          type: string
          format: email
        plan:
          type: string
          enum: [free, professional, enterprise]
          default: professional
        settings:
          type: object
          additionalProperties: true

    TenantResponse:
      type: object
      required:
        - id
        - name
        - status
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        admin_email:
          type: string
          format: email
        plan:
          type: string
        status:
          type: string
          enum: [active, suspended, deleted]
        created_at:
          type: string
          format: date-time
        settings:
          type: object
          additionalProperties: true

    TenantListResponse:
      type: object
      required:
        - items
        - total
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/TenantResponse"
        total:
          type: integer
        page:
          type: integer
        page_size:
          type: integer

    # Error Schema
    ErrorResponse:
      type: object
      required:
        - type
        - title
        - status
      properties:
        type:
          type: string
          format: uri
          description: Error type URI
        title:
          type: string
          description: Short error title
        status:
          type: integer
          description: HTTP status code
        detail:
          type: string
          description: Detailed error message
        instance:
          type: string
          description: Request path
        errors:
          type: array
          items:
            type: object
            properties:
              field:
                type: string
              message:
                type: string
          description: Field-level validation errors
        trace_id:
          type: string
          description: Request trace ID for debugging

# Default security
security:
  - ApiKeyAuth: []
